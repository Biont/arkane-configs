x-ollama-base: &ollama-base
  container_name: ollama
  tty: true
  restart: unless-stopped
  ports:
    - 11433:11434
  volumes:
    - /var/opt/llm/docker/ollama/ollama:/root/.ollama
  environment:
    - OLLAMA_KEEP_ALIVE=24h

services:
  # -------------------------
  # Default: CPU-only
  # -------------------------
  ollama:
    <<: *ollama-base
    image: ollama/ollama:latest
    profiles: [cpu]

  # -------------------------
  # AMD GPU (ROCm)
  # -------------------------
  ollama-amd:
    <<: *ollama-base
    image: ollama/ollama:rocm
    profiles: [amd]
    environment:
      - OLLAMA_KEEP_ALIVE=24h
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-}
    devices:
      - /dev/dri
      - /dev/kfd
    group_add:
      - video
    ipc: host
    privileged: true
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
